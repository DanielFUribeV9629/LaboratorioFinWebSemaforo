<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>Semaforos</title>
</head>
<body>

    <div class="container">

        <div class="row align-items-center">
            <div class="col lblPrincipal">
                <h2>Control de semaforos</h2>
            </div>
        </div>

        <div class="row align-items-center">
            <div class="col semaforo">
                <div class="d-grid gap-2 col-6 mx-auto">
                    <input type="radio" class="btn-check" name="options-outlined" id="Rojo1" autocomplete="off" value="R">
                    <label class="btn btn-outline-danger" for="Rojo1">Rojo</label>

                    <input type="radio" class="btn-check" name="options-outlined" id="amarillo1" autocomplete="off" value="A">
                    <label class="btn btn-outline-warning" for="amarillo1">Amarillo</label>

                    <input type="radio" class="btn-check" name="options-outlined" id="verde1" autocomplete="off" checked value="V">
                    <label class="btn btn-outline-success" for="verde1">Verde</label>
                </div>

            </div>
            <div class="col semaforo">
                <div class="d-grid gap-2 col-6 mx-auto">
                    <input type="radio" class="btn-check" name="options-outlined2" id="Rojo2" autocomplete="off" value="R">
                    <label class="btn btn-outline-danger" for="Rojo2">Rojo</label>

                    <input type="radio" class="btn-check" name="options-outlined2" id="amarillo2" autocomplete="off" value="A">
                    <label class="btn btn-outline-warning" for="amarillo2">Amarillo</label>

                    <input type="radio" class="btn-check" name="options-outlined2" id="verde2" autocomplete="off" checked value="V">
                    <label class="btn btn-outline-success" for="verde2">Verde</label>
                </div>
            </div>
        </div>


        <div class="row align-items-center">
            <div class="col">
                <div class="mb-3">
                    <h3>Grupo 1</h3>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <h3>Grupo 2</h3>
                </div>
            </div>
        </div>
        <div class="row align-items-start">
            <div class="col">
                <div class="mb-3">
                    <label for="numSemaforos1" class="form-label">Cantidad de semaforos</label>
                    <input type="number" class="form-control" id="numSemaforos1" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="numSemaforos2" class="form-label">Cantidad de semaforos</label>
                    <input type="number" class="form-control" id="numSemaforos2" placeholder="0" disabled>
                </div>
            </div>
        </div>
        <div class="row align-items-start">
            <div class="col">
                <div class="mb-3">
                    <label for="lucesRojas1" class="form-label">Luces Rojas</label>
                    <input type="number" class="form-control" id="lucesRojas1" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="lucesAmarillas1" class="form-label">Luces Amarillas</label>
                    <input type="number" class="form-control" id="lucesAmarillas1" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="lucesVerdes1" class="form-label">Luces Verdes</label>
                    <input type="number" class="form-control" id="lucesVerdes1" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="lucesRojas2" class="form-label">Luces Rojas</label>
                    <input type="number" class="form-control" id="lucesRojas2" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="lucesAmarillas2" class="form-label">Luces Amarillas</label>
                    <input type="number" class="form-control" id="lucesAmarillas2" placeholder="0" disabled>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <label for="lucesVerdes2" class="form-label">Luces Verdes</label>
                    <input type="number" class="form-control" id="lucesVerdes2" placeholder="0" disabled>
                </div>
            </div>
        </div>

        <div class="row align-items-start barraOpciones">
            <div class="col">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle listaServidores" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                        Servidor-Cliente
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                    </ul>
                </div>
            </div>
            <div class="col">
                <div class="mb-3">
                    <input type="text" class="form-control" id="servidorSelected" placeholder="" disabled>
                </div>
            </div>
            <div class="col">
                <div class="d-grid gap-2">
                    <button type="button" id="btnActualizar" class="btn btn-primary">Actualizar</button>
                </div>
            </div>
        </div>



    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const div = document.querySelector('.dropdown-menu');

        $('#btnActualizar').on('click', async function (event) {
            event.preventDefault(); // To prevent following the link (optional)
            console.log("Actualizar");
            var radioValue1 = $("input[name='options-outlined']:checked").val();
            var radioValue2 = $("input[name='options-outlined2']:checked").val();
            var servSel = $('#servidorSelected').val();
            var optServ = servSel.split('-');

            var data = [
                {
                    luz_roja: (radioValue1 == "R") ? true : false,
                    luz_amarilla: (radioValue1 == "A") ? true : false,
                    luz_verde: (radioValue1 == "V") ? true : false,
                    client_id: optServ[1],
                    group_id: 1,
                    serverId: optServ[0]
                },
                {
                    luz_roja: (radioValue2 == "R") ? true : false,
                    luz_amarilla: (radioValue2 == "A") ? true : false,
                    luz_verde: (radioValue2 == "V") ? true : false,
                    client_id: optServ[1],
                    group_id: 2,
                    serverId: optServ[0]
                }
            ];

            console.log(radioValue1);
            console.log(radioValue2);
            console.log(data);
            try {

                await fetch('http://localhost:8000/semaforoAct/create_request', {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-type': 'application/json'
                    }
                });
                await getServerClientData(optServ[0], optServ[1]);
            }

            catch (error) {
                console.log(error)
            }
        });

        var myDropdown = document.querySelector('.dropdown');
        myDropdown.addEventListener('show.bs.dropdown', async function () {

            const retReq = await fetch('http://localhost:8000/semaforo/get/all')
            const ret = await retReq.json()

            //const retReq = '[{"llave":1,"client_id":1212,"cant_semaforos":4,"luz_red_broken":2,"luz_yellow_broken":2,"luz_green_broken":2,"group_id":1,"serverId":2}, {"llave":1,"client_id":1212,"cant_semaforos":4,"luz_red_broken":2,"luz_yellow_broken":2,"luz_green_broken":2,"group_id":2,"serverId":2}]';
            //const ret = JSON.parse(retReq);

            console.log(ret)

            div.innerHTML = "";
            ret.forEach(item => {
                div.innerHTML += `<li><a class="dropdown-item" href="#">${item.serverId}-${item.client_id}</a></li>`;
            });

            $('.dropdown-menu li').on('click', async function () {
                console.log($(this).text());
                $('#servidorSelected').val($(this).text());
                var options = $(this).text().split('-');
                await getServerClientData(options[0], options[1]);
            });
        })

        const getServerClientData = async (idServer, idClient) => {
            try {
                const retReq = await fetch(`http://localhost:8000/semaforo/get/server/${idServer}`)
                const ret = await retReq.json()

                //const retReq = '[{"llave":1,"client_id":1212,"cant_semaforos":4,"luz_red_broken":2,"luz_yellow_broken":2,"luz_green_broken":2,"group_id":1,"serverId":2}, {"llave":1,"client_id":1212,"cant_semaforos":7,"luz_red_broken":1,"luz_yellow_broken":5,"luz_green_broken":6,"group_id":2,"serverId":2}]';
                //const ret = JSON.parse(retReq);
                console.log(ret)
                ret.forEach(item => {
                    if (item.client_id == idClient) {
                        if (item.group_id == 1) {
                            $('#numSemaforos1').val(item.cant_semaforos);
                            $('#lucesRojas1').val(item.luz_red_broken);
                            $('#lucesAmarillas1').val(item.luz_yellow_broken);
                            $('#lucesVerdes1').val(item.luz_green_broken);
                        }
                        if (item.group_id == 2) {
                            $('#numSemaforos2').val(item.cant_semaforos);
                            $('#lucesRojas2').val(item.luz_red_broken);
                            $('#lucesAmarillas2').val(item.luz_yellow_broken);
                            $('#lucesVerdes2').val(item.luz_green_broken);
                        }
                    }
                });

            }
            catch (error) {
                console.log(error)
            }
        }

    </script>
    <style>
        .lblPrincipal {
            width: 100%;
            text-align: center;
            margin: 5px;
            padding: 20px;
            background-color: #efefef;
        }

        .semaforo {
            margin: 50px;
        }

        .listaServidores {
            width: 100%;
        }

        .barraOpciones {
            margin: 20px 0px;
            background-color: #efefef;
            padding: 20px 0px;
        }
    </style>
</body>
</html>